<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulário de Ocorrência</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Days+One&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simple-line-icons/2.5.5/css/simple-line-icons.min.css" />

  <link href="https://fonts.googleapis.com/css2?family=Public+Sans&display=swap" rel="stylesheet">
      <style>
        body {
       padding-top: 70px;
       background-color: #e5edf0;
     }
   
     .navbar-custom {
       background-color: #ffffff;
       box-shadow: 0 2px 4px rgba(0,0,0,0.1);
     }
   
     .navbar-brand {
       font-size: 1.3rem;
       color: #037171;
       font-size: 20px;
       font-family: 'Days One', sans-serif;
     }
   
     .navbar-brand:hover {
       color: #0f3636;
     }
   
     .btn-arrow {
       background-color: #ead2d2;
       border: none;
       font-size: 1.1rem;
     }
   
     .table thead {
       background-color: #f0f0f0;
     }
   
     .avatar-img {
       width: 30px;
       height: 30px;
       border-radius: 50%;
       object-fit: cover;
     }
   
     .nav-link-icon {
       font-size: 1.1rem;
       color: #333;
     }
   
     .nav-link-icon:hover {
       color: #179a9a;
     }
   
     /* Ícons canto direito */
     .nav-link{
       color: #037171 !important;
     }
   
     .nav-link:hover{
       color:#054048 !important;
     }
   
     /* Estilo do botão "Ocorrências Revistas" */
     .btn-outline-secondary {
       background-color: #E9ECEF;
       color: #777777;
       border-color: #DDDDDD;
       border-radius: 12px;
       width: 179.2px; 
         height: 33px; 
       display: flex;
         justify-content: center;  
         align-items: center;     
         text-align: center;
     }
   
     .form-control {
         width: 286.5px;
         height: 44px;
     }
   
     .card-header h5{
         font-size: 16px;
       font-family: 'Days One', sans-serif;
     }
   
     h3.text-danger {
         font-size: 16px; 
         font-family: 'Days One', sans-serif;
       color: #893037 !important;
     }
   
     .op-7{
       color: #037171;
     }
   
     .fw{
       color: #037171;
     }
   
     .logo-icon {
         position: relative;
         top: 4px;
     }
   
     .profile-pic {
         color: #000 !important; 
         text-decoration: none !important;
     }
   
     #ocorrencias {
         font-family: 'Public Sans', sans-serif;
       }
   
     .custom-container {
         max-width: 90%; /* ou 1200px, por exemplo */
     }
   
     .custom-btn {
         background-color: #E1CBCD;
         color: #000; 
         border: none;
     }
   
     .custom-btn:hover {
         background-color: #af888b !important;
       }
   
     .link-ocorrencias {
       color: #893037 !important;
       text-decoration: none;
       font-weight: normal;
       font-size: 12px;
     }
   
     .link-ocorrencias:hover {
       color: #000;
     }

     .card-body {
      padding-bottom: 5px; /* aumenta espaço inferior */
    }

     .card-action {
        border-top: 1px solid #dbd6d6 !important;
        padding: 2rem 1rem;;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }

      .btn-success {
        background-color: #054048 !important; 
        color: white !important;
        border: none !important;
      }

      .btn-success:hover {
        background-color: #042226 !important;
        border-color: none !important;
      }    
      
      .btn-danger {
        background-color: #893037 !important;
        border-color: none !important;
        color: white !important;
      }

      .btn-danger:hover {
        background-color: #68252b !important;
        border-color: none !important;
        color: white !important;
      }

      .dropdown-user {
        left: 50% !important;
        right: 0 !important;
        transform: translateX(-50%);
	    }

      .dropdown-user .user-box {
        text-align: center;
        padding: 10px;
      }

      #userFotoBig {
        width: 45px;
        height: 45px;
        object-fit: cover;
      }

      #userNomeBig {
        font-size: 1.2rem; 
        font-weight: 500;  
        font-family: 'Public Sans', sans-serif; 
        margin-top: 10px;
      }

      #userEmail {
        font-size: 0.9rem;
        color: #6c757d; 
        word-break: break-all; 
        display: block;
        margin: 0 auto;
        max-width: 90%; 
      }

     </style>
   </head>
   <body>
     <!-- Top Navbar -->
     <nav class="navbar navbar-expand-lg navbar-light fixed-top navbar-custom px-4">
       <a class="navbar-brand d-flex align-items-center gap-2 me-3" href="datatables-OpR.html">
       <svg xmlns="http://www.w3.org/2000/svg" width="37" height="37" viewBox="0 -4 20 24" fill="none">
         <svg width="20" height="20" viewBox="0 0 37 37" fill="none" xmlns="http://www.w3.org/2000/svg">
           <path fill-rule="evenodd" clip-rule="evenodd" d="M2.168 9.99113C2.35415 9.91143 2.55418 9.86918 2.75667 9.86681C2.95915 9.86443 3.16012 9.90196 3.34809 9.97727C3.53606 10.0526 3.70736 10.1642 3.8522 10.3057C3.99703 10.4472 4.11257 10.6159 4.19221 10.802L2.77542 11.4095L4.19375 10.802L4.19838 10.8144L4.23075 10.8838L4.37567 11.1828C4.50825 11.448 4.71329 11.8365 4.99234 12.3067C5.72812 13.5428 6.59099 14.6986 7.56692 15.7554C7.85942 16.0701 8.1628 16.3745 8.4765 16.6681C10.7613 18.8095 13.954 20.6595 18.1921 20.6595C19.8906 20.6672 21.5752 20.3523 23.1563 19.7314C25.0479 18.9868 26.6312 17.866 27.9293 16.6511C29.6653 15.0038 31.0923 13.0589 32.1426 10.9084L32.1843 10.819L32.192 10.802C32.3569 10.4321 32.6608 10.1418 33.0379 9.99413C33.4151 9.84643 33.8353 9.8531 34.2076 10.0127C34.5799 10.1723 34.8744 10.4721 35.0275 10.8471C35.1805 11.2221 35.1798 11.6423 35.0255 12.0169L35.0225 12.0246L35.0163 12.0369L34.9993 12.077L34.9377 12.2111C34.5953 12.9243 34.2139 13.618 33.7953 14.2893C33.0247 15.5272 32.1417 16.6914 31.1575 17.7673L32.3862 18.996C32.6755 19.2851 32.8381 19.6772 32.8382 20.0862C32.8384 20.4951 32.6761 20.8874 32.387 21.1767C32.0979 21.466 31.7058 21.6286 31.2968 21.6287C30.8878 21.6289 30.4956 21.4665 30.2063 21.1775L28.9113 19.8825C28 20.6191 27.0207 21.2674 25.9868 21.8188L27.1923 23.6719C27.3061 23.8415 27.385 24.032 27.4245 24.2324C27.4639 24.4328 27.4632 24.639 27.4223 24.8391C27.3815 25.0392 27.3012 25.2291 27.1863 25.398C27.0714 25.5668 26.9241 25.7111 26.7529 25.8225C26.5818 25.9339 26.3902 26.0102 26.1893 26.047C25.9884 26.0837 25.7822 26.0802 25.5827 26.0366C25.3832 25.993 25.1943 25.9102 25.0271 25.793C24.8599 25.6758 24.7176 25.5265 24.6085 25.3538L23.0884 23.0198C22.0416 23.3404 20.9239 23.567 19.7338 23.6734V26.0553C19.7338 26.4642 19.5713 26.8563 19.2822 27.1454C18.9931 27.4345 18.601 27.597 18.1921 27.597C17.7832 27.597 17.3911 27.4345 17.102 27.1454C16.8128 26.8563 16.6504 26.4642 16.6504 26.0553V23.675C15.4556 23.567 14.3379 23.3404 13.2942 23.0198L11.7757 25.3538C11.5477 25.6845 11.1996 25.9131 10.8056 25.9911C10.4116 26.069 10.0027 25.9901 9.66596 25.7711C9.32925 25.5521 9.0913 25.2103 9.00274 24.8186C8.91419 24.4268 8.98204 24.0159 9.19184 23.6734L10.3974 21.8188C9.31825 21.2484 8.34392 20.5855 7.47288 19.8809L6.17788 21.1759C5.88712 21.4567 5.49769 21.6121 5.09347 21.6086C4.68925 21.6051 4.30258 21.443 4.01674 21.1571C3.7309 20.8713 3.56877 20.4846 3.56525 20.0804C3.56174 19.6762 3.71713 19.2868 3.99796 18.996L5.22667 17.7673C4.136 16.5743 3.17002 15.2731 2.34375 13.8838C2.01469 13.3289 1.71067 12.7594 1.43263 12.1772L1.38175 12.0662L1.36634 12.0338L1.36325 12.023L1.36171 12.02C1.35709 12.02 1.35709 12.0169 2.77542 11.4095L1.35863 12.0184C1.27864 11.8323 1.23613 11.6322 1.23353 11.4296C1.23092 11.227 1.26827 11.0259 1.34344 10.8378C1.41861 10.6497 1.53012 10.4782 1.67161 10.3332C1.81309 10.1882 1.98177 10.0709 2.168 9.99113Z" fill="#037171"/>
         </svg>				
         <path d="..." fill="currentColor" />
       </svg>
       <span>EyesEverywhere</span>
       </a>
       
     <!-- ícons canto direito -->
     <ul class="navbar-nav topbar-nav ms-md-auto align-items-center">
      <li class="nav-item me-3">
        <a class="nav-link fw-semibold" href="datatables-OpR.html">Home</a>
        </li>
        <li class="nav-item me-3">
        <a class="nav-link fw-semibold" href="datatables-OR.html">Histórico</a>
        </li>
      <li
        class="nav-item topbar-icon dropdown hidden-caret d-flex d-lg-none"
      >
        <a
        class="nav-link dropdown-toggle"
        data-bs-toggle="dropdown"
        href="#"
        role="button"
        aria-expanded="false"
        aria-haspopup="true"
        >
        <i class="fa fa-search"></i>
        </a>
        <ul class="dropdown-menu dropdown-search animated fadeIn">
        <form class="navbar-left navbar-form nav-search">
          <div class="input-group">
          <input
            type="text"
            placeholder="Search ..."
            class="form-control"
          />
          </div>
        </form>
        </ul>
      </li>
      <li class="nav-item topbar-user dropdown hidden-caret">
        <a
          class="dropdown-toggle profile-pic d-flex align-items-center"
          data-bs-toggle="dropdown"
          href="#"
          aria-expanded="false"
        >
          <div class="avatar-sm">
          <img
            id="userFoto"
            src=""
            alt="..."
            class="avatar-img rounded-circle"
          />
          </div>
          <span class="profile-username ms-2">
          <span class="op-7">Olá,</span>
          <span class="fw" id="userNome"> Utilizador</span>
          </span>
        </a>
        
        <ul class="dropdown-menu dropdown-user animated fadeIn text-center">
          <li class="px-3 py-2">
          <div class="user-box">
            <div class="avatar-lg mx-auto">
            <img
              id="userFotoBig"
              src=""
              alt="image profile"
              class="avatar-img rounded"
            />
            </div>
            <div class="u-text mt-2">
            <h4 id="userNomeBig">Utilizador</h4>
            <p class="text-muted mb-1" id="userEmail">email@email.com</p>
            <a
              href="diagramas.html"
              class="btn btn-sm btn-secondary"
            >
              Ver Perfil
            </a>
            </div>
          </div>
          </li>
          <li><hr class="dropdown-divider"></li>
          <li>
          <a class="dropdown-item text-center" href="login.html">Logout</a>
          </li>
        </ul>
        </li>      
      </ul>
    </div>
    </nav>
    <!-- End Navbar -->
   
     <!-- Main Content -->
     <div class="container py-4">
      <h3 class="text-danger fw-bold mb-4 d-flex align-items-center gap-2">
        Formulário
      </h3>
    
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Ocorrências</h5>
        </div>
    
        <div class="card-body">
          <div class="row">
            <div class="col-md-4">
              <div class="form-group">
                <label for="titulo">Título da Ocorrência</label>
                <input type="text" class="form-control" id="titulo" placeholder="Insira o título" />
              </div>
    
              <div class="form-group mt-3">
                <label for="tipo">Tipo de Problema</label>
                <input type="text" class="form-control" id="tipo" placeholder="Insira o tipo" />
              </div>
    
              <div class="form-group mt-3">
                <label for="morada">Local</label>
                <input type="text" class="form-control" id="morada" placeholder="Ex: Rua da Universidade, 123" />
              </div>
            </div>
    
            <div class="col-md-4">  
              <div class="form-group">
                <label for="descricao">Descrição</label>
                <textarea class="form-control" id="descricao" rows="3" placeholder="Descreva o problema..."></textarea>
              </div>
    
              <div class="form-group mt-3">
                <label for="relatorio">Relatório</label>
                <textarea class="form-control" id="relatorio" rows="3" placeholder="Insira o relatório detalhado..."></textarea>
              </div>
    
              <div class="form-group mt-4">
                <label for="comentarios">Comentários</label>
                <textarea class="form-control" id="comentarios" rows="7" placeholder="Comentários adicionais..."></textarea>
              </div>
            </div>

              <div class="col-md-4">
                <div class="form-group">
                  <label for="exampleFormControlFile1">Anexar Ficheiro</label>
                  <input
                    type="file"
                    class="form-control-file"
                    id="exampleFormControlFile1"
                  />
                </div>
            </div>

              <div id="estado"></div>

              <div id="mensagem" class="alert d-none mt-3"></div>

              <div class="card-action d-flex justify-content-end gap-2 mt-5">
                <button class="btn btn-success me-2" type="button" onclick="confirmarOcorrencia()">Confirmar</button>
                <button class="btn btn-success me-2" onclick="fecharOcorrencia()">Fechar</button>
              </div>
              
            </div>
        </div> 
      </div> 
    </div> 
    
   
     <!-- Scripts -->
     <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
     <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
     <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

     <script>
      window.addEventListener("DOMContentLoaded", () => {
        const dados = localStorage.getItem("ocorrenciaSelecionada");
      
        if (dados) {
          const ocorrencia = JSON.parse(dados);
      
          // Preenche os campos do formulário
          document.getElementById("titulo").value = ocorrencia.titulo || "";
          document.getElementById("tipo").value = ocorrencia.tipo || "";
          document.getElementById("morada").value = ocorrencia.morada || "";
          document.getElementById("descricao").value = ocorrencia.descricao || "";
          document.getElementById("relatorio").value = ocorrencia.relatorio || "";
          document.getElementById("comentarios").value = ocorrencia.comentarios || "";

          const previewDiv = document.getElementById("previewAnexo");
            if (ocorrencia.anexo) {
              const imagePath = `assets/${ocorrencia.anexo}`; // caminho da imagem no servidor
              previewDiv.innerHTML = `<img src="${imagePath}" alt="Anexo" style="max-width: 100%; height: auto; border: 1px solid #ccc; padding: 5px;">`;
            } else {
              previewDiv.innerHTML = '<span class="text-muted">Sem anexo</span>';
            }

      
          // Pega o ID da ocorrência que foi guardado
          const id = localStorage.getItem("ocorrenciaIdSelecionada");
      
          // Adiciona o listener ao campo "relatorio"
          document.getElementById("relatorio").addEventListener("input", function () {
            console.log("Relatório alterado:", this.value);
            // Atualiza apenas o campo relatorio na ocorrência
            ocorrencia.relatorio = this.value;
      
            // Atualiza no localStorage
            localStorage.setItem("ocorrenciaSelecionada", JSON.stringify(ocorrencia));
      
            // Atualiza o objeto global de todas as ocorrências
            
              let dadosOcorrencias = JSON.parse(localStorage.getItem("dadosOcorrencias")) || {};
              dadosOcorrencias[id] = ocorrencia;
              localStorage.setItem("dadosOcorrencias", JSON.stringify(dadosOcorrencias));

          });
        }
      });
      </script>      
    <script>
      function mostrarMensagem(status) {
        const mensagemDiv = document.getElementById("mensagem");
    
        if (status === "confirmado") {
          mensagemDiv.textContent = "Ocorrência confirmada com sucesso!";
          mensagemDiv.className = "alert alert-success mt-3";
        }
    
        // Mostrar a mensagem
        mensagemDiv.classList.remove("d-none");
    
        // Esconder após 3 segundos
        setTimeout(() => {
          mensagemDiv.classList.add("d-none");
        }, 3000);
      }
    </script>
    <script>
      function confirmarOcorrencia() {
        const titulo = document.getElementById("titulo").value || "Sem título";
        const tipo = document.getElementById("tipo").value || "";
        const morada = document.getElementById("morada").value || "";
        const descricao = document.getElementById("descricao").value || "";
        const relatorio = document.getElementById("relatorio").value || "";
        const comentarios = document.getElementById("comentarios").value || "";

        const dataAtual = new Date().toLocaleDateString("pt-PT");

        // O id da ocorrência a confirmar deve estar guardado no localStorage (quando carregas no botão "ver" da tabela)
        const id = JSON.parse(localStorage.getItem("ocorrenciaIdSelecionada"));

          if (!id) {
              alert("Erro: Nenhuma ocorrência selecionada.");
              return;
          }

          let dadosTabela = JSON.parse(localStorage.getItem("dadosTabelaOcorrencias")) || {};

          // Obtem a ocorrência ativa
          let ocorrenciaAtiva = dadosTabela[id];
          if (!ocorrenciaAtiva) {
              alert("Erro: Ocorrência não encontrada na lista ativa.");
              return;
          }

          // Remove a ocorrência da lista ativa (podes também só mudar o estado para "Concluída" se preferires)
          delete dadosTabela[id];

          // Atualiza o localStorage da lista ativa
          localStorage.setItem("dadosTabelaOcorrencias", JSON.stringify(dadosTabela));

      const novaOcorrencia = {
        id: crypto.randomUUID(),
        titulo,
        data: dataAtual,
        tipo,
        morada,
        descricao,
        relatorio,
        comentarios
      };

      let historico = JSON.parse(localStorage.getItem("historicoOcorrencias")) || [];

      historico.push(novaOcorrencia);

      historico = historico.map((item, index) => ({
        id: index, 
        ...item
      }));

      localStorage.setItem("historicoOcorrencias", JSON.stringify(historico));

      mostrarMensagem("confirmado");

      window.location.href = "datatables-OR.html";
    }
    </script>
    <script>
      function fecharOcorrencia() {
      const id = localStorage.getItem("ocorrenciaIdSelecionada");
      if (!id) {
        alert("Nenhuma ocorrência selecionada.");
        return;
      }

      const dadosTabela = JSON.parse(localStorage.getItem("dadosTabelaOcorrencias")) || {};
      const dadosOcorrencias = JSON.parse(localStorage.getItem("dadosOcorrencias")) || {};
      const ocorrenciaAtualizada = JSON.parse(localStorage.getItem("ocorrenciaSelecionada")) || {};

      if (dadosTabela[id]) {
        dadosTabela[id].estado = "Por concluir";
        localStorage.setItem("dadosTabelaOcorrencias", JSON.stringify(dadosTabela));
        alert("Estado atualizado para 'Por concluir'.");
      } else {
        alert("Ocorrência não encontrada na tabela.");
      }

      if (dadosOcorrencias[id]) {
        // Atualiza o relatório da ocorrência principal
        dadosOcorrencias[id].relatorio = ocorrenciaAtualizada.relatorio || dadosOcorrencias[id].relatorio;
        
        localStorage.setItem("dadosOcorrencias", JSON.stringify(dadosOcorrencias));
      } else {
        alert("Ocorrência não encontrada nos dados principais.");
      }


      // Redireciona para a página da tabela
      window.location.href = "datatables-OpR.html";
    }

    // Inicializa e renderiza tabela ao carregar
    window.onload = () => {
      initDadosTabela();
      renderizarTabela();
      }
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
      const userData = JSON.parse(localStorage.getItem('googleUser'));
      if (userData) {
        const nome = userData.nome;
        const email = userData.email;
        const foto = userData.foto;
  
        if (document.getElementById('userFoto')) document.getElementById('userFoto').src = foto;
        if (document.getElementById('userFotoBig')) document.getElementById('userFotoBig').src = foto;
        if (document.getElementById('userNome')) document.getElementById('userNome').textContent = nome;
        if (document.getElementById('userNomeBig')) document.getElementById('userNomeBig').textContent = nome;
        if (document.getElementById('userEmail')) document.getElementById('userEmail').textContent = email;
      }
    });
  
    function logoutGoogle() {
      localStorage.removeItem('googleUser');
      window.location.href = 'login.html';
    }
  
    // Simulação de login Google (modo manual para teste)
    if (!localStorage.getItem("googleUser")) {
      localStorage.setItem("googleUser", JSON.stringify({
        nome: "Inês Martins",
        email: "inesn.martins14@gmail.com",
        foto: "https://i.pravatar.cc/150?img=5"
      }));
    }
    </script>
</body>
</html>

