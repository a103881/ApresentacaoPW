<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Perfil</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Days+One&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simple-line-icons/2.5.5/css/simple-line-icons.min.css" />

  <link href="https://fonts.googleapis.com/css2?family=Public+Sans&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body {
		padding-top: 70px;
		background-color: #e5edf0;
	}

	.navbar-custom {
		background-color: #ffffff;
		box-shadow: 0 2px 4px rgba(0,0,0,0.1);
	}

	.navbar-brand {
		font-size: 1.3rem;
		color: #037171;
		font-size: 20px;
		font-family: 'Days One', sans-serif;
	}

	.navbar-brand:hover {
		color: #0f3636;
	}

	.table thead {
		background-color: #f0f0f0;
	}

	.avatar-img {
		width: 30px;
		height: 30px;
		border-radius: 50%;
		object-fit: cover;
	}

	.btn-outline-secondary {
		background-color: #E9ECEF;
		color: #777777;
		border-color: #DDDDDD;
		border-radius: 12px;
		width: auto; 
    	height: 38px; 
		display: flex;
    	justify-content: center;  
    	align-items: center;     
    	text-align: center;
		white-space: nowrap;
	}

	.form-control {
  		width: 286.5px;
  		height: 44px;
	}

	.card-header h5{
  		font-size: 16px;
		font-family: 'Days One', sans-serif;
	}

	.op-7{
		color: #037171;
	}

    .fw{
		color: #037171;
	}

	.logo-icon {
  		position: relative;
  		top: 4px;
	}

	.profile-pic {
  		color: #000 !important; 
  		text-decoration: none !important;
	}

	#ocorrencias {
    	font-family: 'Public Sans', sans-serif;
  	}

    .gm-title {
        margin-top: 40px; 
        font-family: 'Days One', sans-serif;
		color: #324753 !important;
    }

    .card {
        height: 350px; 
    }

    .chart-container {
        height: 250px; 
    }

    .nav-link{
       color: #037171 !important;
     }
   
     .nav-link:hover{
       color:#054048 !important;
     }

     .dropdown-user {
		left: 50% !important;
		right: 0 !important;
		transform: translateX(-50%);
	}

    .mapa-card {
        height: 500px; /* controla altura do cartão */
        padding: 0;
    }
    .card-body {
        height: 100%; /* para herdar do mapa-card */
        padding: 0;
    }

    .dropdown-user .user-box {
        text-align: center;
        padding: 10px;
      }

      #userFotoBig {
        width: 45px;
        height: 45px;
        object-fit: cover;
      }

      #userNomeBig {
        font-size: 1.2rem; 
        font-weight: 500;  
        font-family: 'Public Sans', sans-serif; 
        margin-top: 10px;
      }

      #userEmail {
        font-size: 0.9rem;
        color: #6c757d; 
        word-break: break-all; 
        display: block;
        margin: 0 auto;
        max-width: 90%; 
      }

  </style>
  </head>

  <body>
    <!-- Top Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top navbar-custom px-4">
        <a class="navbar-brand d-flex align-items-center gap-2 me-3" href="#">
            <svg xmlns="http://www.w3.org/2000/svg" width="37" height="37" viewBox="0 -4 20 24" fill="none">
                <svg width="20" height="20" viewBox="0 0 37 37" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M2.168 9.99113C2.35415 9.91143 2.55418 9.86918 2.75667 9.86681C2.95915 9.86443 3.16012 9.90196 3.34809 9.97727C3.53606 10.0526 3.70736 10.1642 3.8522 10.3057C3.99703 10.4472 4.11257 10.6159 4.19221 10.802L2.77542 11.4095L4.19375 10.802L4.19838 10.8144L4.23075 10.8838L4.37567 11.1828C4.50825 11.448 4.71329 11.8365 4.99234 12.3067C5.72812 13.5428 6.59099 14.6986 7.56692 15.7554C7.85942 16.0701 8.1628 16.3745 8.4765 16.6681C10.7613 18.8095 13.954 20.6595 18.1921 20.6595C19.8906 20.6672 21.5752 20.3523 23.1563 19.7314C25.0479 18.9868 26.6312 17.866 27.9293 16.6511C29.6653 15.0038 31.0923 13.0589 32.1426 10.9084L32.1843 10.819L32.192 10.802C32.3569 10.4321 32.6608 10.1418 33.0379 9.99413C33.4151 9.84643 33.8353 9.8531 34.2076 10.0127C34.5799 10.1723 34.8744 10.4721 35.0275 10.8471C35.1805 11.2221 35.1798 11.6423 35.0255 12.0169L35.0225 12.0246L35.0163 12.0369L34.9993 12.077L34.9377 12.2111C34.5953 12.9243 34.2139 13.618 33.7953 14.2893C33.0247 15.5272 32.1417 16.6914 31.1575 17.7673L32.3862 18.996C32.6755 19.2851 32.8381 19.6772 32.8382 20.0862C32.8384 20.4951 32.6761 20.8874 32.387 21.1767C32.0979 21.466 31.7058 21.6286 31.2968 21.6287C30.8878 21.6289 30.4956 21.4665 30.2063 21.1775L28.9113 19.8825C28 20.6191 27.0207 21.2674 25.9868 21.8188L27.1923 23.6719C27.3061 23.8415 27.385 24.032 27.4245 24.2324C27.4639 24.4328 27.4632 24.639 27.4223 24.8391C27.3815 25.0392 27.3012 25.2291 27.1863 25.398C27.0714 25.5668 26.9241 25.7111 26.7529 25.8225C26.5818 25.9339 26.3902 26.0102 26.1893 26.047C25.9884 26.0837 25.7822 26.0802 25.5827 26.0366C25.3832 25.993 25.1943 25.9102 25.0271 25.793C24.8599 25.6758 24.7176 25.5265 24.6085 25.3538L23.0884 23.0198C22.0416 23.3404 20.9239 23.567 19.7338 23.6734V26.0553C19.7338 26.4642 19.5713 26.8563 19.2822 27.1454C18.9931 27.4345 18.601 27.597 18.1921 27.597C17.7832 27.597 17.3911 27.4345 17.102 27.1454C16.8128 26.8563 16.6504 26.4642 16.6504 26.0553V23.675C15.4556 23.567 14.3379 23.3404 13.2942 23.0198L11.7757 25.3538C11.5477 25.6845 11.1996 25.9131 10.8056 25.9911C10.4116 26.069 10.0027 25.9901 9.66596 25.7711C9.32925 25.5521 9.0913 25.2103 9.00274 24.8186C8.91419 24.4268 8.98204 24.0159 9.19184 23.6734L10.3974 21.8188C9.31825 21.2484 8.34392 20.5855 7.47288 19.8809L6.17788 21.1759C5.88712 21.4567 5.49769 21.6121 5.09347 21.6086C4.68925 21.6051 4.30258 21.443 4.01674 21.1571C3.7309 20.8713 3.56877 20.4846 3.56525 20.0804C3.56174 19.6762 3.71713 19.2868 3.99796 18.996L5.22667 17.7673C4.136 16.5743 3.17002 15.2731 2.34375 13.8838C2.01469 13.3289 1.71067 12.7594 1.43263 12.1772L1.38175 12.0662L1.36634 12.0338L1.36325 12.023L1.36171 12.02C1.35709 12.02 1.35709 12.0169 2.77542 11.4095L1.35863 12.0184C1.27864 11.8323 1.23613 11.6322 1.23353 11.4296C1.23092 11.227 1.26827 11.0259 1.34344 10.8378C1.41861 10.6497 1.53012 10.4782 1.67161 10.3332C1.81309 10.1882 1.98177 10.0709 2.168 9.99113Z" fill="#037171"/>
                </svg>				
            <path d="..." fill="currentColor" />
            </svg>
            <span>EyesEverywhere</span>
        </a>
        
        <!-- ícons canto direito -->
        <ul class="navbar-nav topbar-nav ms-md-auto align-items-center">
            <li class="nav-item me-3">
                <a class="nav-link fw-semibold" href="datatables-OpR.html">Home</a>
                </li>
            <li class="nav-item topbar-icon dropdown hidden-caret d-flex d-lg-none">
            <a class="nav-link dropdown-toggle"
                data-bs-toggle="dropdown"
                href="#"
                role="button"
                aria-expanded="false"
                aria-haspopup="true">
                <i class="fa fa-search"></i>
            </a>
            <ul class="dropdown-menu dropdown-search animated fadeIn">
                <form class="navbar-left navbar-form nav-search">
                <div class="input-group">
                    <input
                    type="text"
                    placeholder="Search ..."
                    class="form-control"
                    />
                </div>
                </form>
            </ul>
            </li>
            <li class="nav-item topbar-user dropdown hidden-caret">
              <a
                class="dropdown-toggle profile-pic d-flex align-items-center"
                data-bs-toggle="dropdown"
                href="#"
                aria-expanded="false"
              >
                <div class="avatar-sm">
                <img
                  id="userFoto"
                  src=""
                  alt="..."
                  class="avatar-img rounded-circle"
                />
                </div>
                <span class="profile-username ms-2">
                <span class="op-7">Olá,</span>
                <span class="fw" id="userNome"> Utilizador</span>
                </span>
              </a>
              
              <ul class="dropdown-menu dropdown-user animated fadeIn text-center">
                <li class="px-3 py-2">
                <div class="user-box">
                  <div class="avatar-lg mx-auto">
                  <img
                    id="userFotoBig"
                    src=""
                    alt="image profile"
                    class="avatar-img rounded"
                  />
                  </div>
                  <div class="u-text mt-2">
                  <h4 id="userNomeBig">Utilizador</h4>
                  <p class="text-muted mb-1" id="userEmail">email@email.com</p>
                  <a
                    href="diagramas.html"
                    class="btn btn-sm btn-secondary"
                  >
                    Ver Perfil
                  </a>
                  </div>
                </div>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                <a class="dropdown-item text-center" href="login.html">Logout</a>
                </li>
              </ul>
              </li>              
        </ul>
        </div>
    </nav>
    <!-- End Navbar -->

    <!--Main Content-->
    <div class="container">
        <div class="page-inner">
          <div class="row">
    <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Ocorrências</div>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas
                id="doughnutChart"
                style="width: 50%; height: 50%"
              ></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Ocorrências por ano</div>
          </div>
          <div class="card-body">
            <div class="chart-container">
              <canvas id="htmlLegendsChart"></canvas>
            </div>
            <div id="myChartLegend"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
    </div>

    <div class="container">
    <div class="page-inner">
      <div class="page-header mb-0">
        <h3 class="gm-title mb-3 days-one-font">Google Maps</h3>
      </div>
      <div class="row">
        <div class="col-md-12">
          <div class="card mapa-card">
            <div class="card-header">
              <div class="card-title">Locais das ocorrências</div>
            </div>
            <div class="card-body">
                <div id="map" style="height: 500px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
   window.onload = function () {
  // 1. Ir buscar os dados do localStorage
  const historico = JSON.parse(localStorage.getItem("historicoOcorrencias")) || [];
  const ativas = JSON.parse(localStorage.getItem("dadosTabelaOcorrencias")) || {};

  const concluidas = historico.length;
  const porConcluir = Object.keys(ativas).length;
  const total = concluidas + porConcluir;

  // 2. Preparar o gráfico doughnut com os dados reais
  const doughnutChart = document.getElementById("doughnutChart").getContext("2d");
  new Chart(doughnutChart, {
    type: "doughnut",
    data: {
      labels: ["Total", "Por concluir", "Concluídas"],
      datasets: [{
        data: [total, porConcluir, concluidas],
        backgroundColor: ["#f3545d", "#fdaf4b", "#1d7af3"]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: "bottom"
        }
      },
      layout: {
        padding: 20
      }
    }
  });

  // --- 3. Função auxiliar para contar por mês ---
  function contarPorMes(ocorrencias) {
    const contagem = new Array(12).fill(0);
    ocorrencias.forEach(ocorrencia => {
      const partesData = ocorrencia.data?.split('/');
      const mes = parseInt(partesData?.[1]) - 1;
      if (!isNaN(mes) && mes >= 0 && mes <= 11) contagem[mes]++;
    });
    return contagem;
  }

  const ativasArray = Object.values(ativas);  // transforma o objeto num array

  const totalPorMes = contarPorMes([...historico, ...ativasArray]);
  const concluidasPorMes = contarPorMes(historico);
  const porConcluirPorMes = contarPorMes(ativasArray);

  // --- 4. Gráfico de linhas ---
  const htmlLegendsChart = document.getElementById("htmlLegendsChart");
  const ctx = htmlLegendsChart.getContext("2d");

  var gradientStroke = ctx.createLinearGradient(500, 0, 100, 0);
  gradientStroke.addColorStop(0, "#177dff");
  gradientStroke.addColorStop(1, "#80b6f4");

  var gradientFill = ctx.createLinearGradient(500, 0, 100, 0);
  gradientFill.addColorStop(0, "rgba(23, 125, 255, 0.7)");
  gradientFill.addColorStop(1, "rgba(128, 182, 244, 0.3)");

  var gradientStroke2 = ctx.createLinearGradient(500, 0, 100, 0);
  gradientStroke2.addColorStop(0, "#f3545d");
  gradientStroke2.addColorStop(1, "#ff8990");

  var gradientFill2 = ctx.createLinearGradient(500, 0, 100, 0);
  gradientFill2.addColorStop(0, "rgba(243, 84, 93, 0.7)");
  gradientFill2.addColorStop(1, "rgba(255, 137, 144, 0.3)");

  var gradientStroke3 = ctx.createLinearGradient(500, 0, 100, 0);
  gradientStroke3.addColorStop(0, "#fdaf4b");
  gradientStroke3.addColorStop(1, "#ffc478");

  var gradientFill3 = ctx.createLinearGradient(500, 0, 100, 0);
  gradientFill3.addColorStop(0, "rgba(253, 175, 75, 0.7)");
  gradientFill3.addColorStop(1, "rgba(255, 196, 120, 0.3)");

  var myHtmlLegendsChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
               "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
      datasets: [
        {
          label: "Total",
          borderColor: gradientStroke2,
          pointBackgroundColor: gradientStroke2,
          pointRadius: 0,
          backgroundColor: gradientFill2,
          legendColor: "#f3545d",
          fill: true,
          borderWidth: 1,
          data: totalPorMes,
        },
        {
          label: "Por concluir",
          borderColor: gradientStroke3,
          pointBackgroundColor: gradientStroke3,
          pointRadius: 0,
          backgroundColor: gradientFill3,
          legendColor: "#fdaf4b",
          fill: true,
          borderWidth: 1,
          data: porConcluirPorMes,
        },
        {
          label: "Concluídas",
          borderColor: gradientStroke,
          pointBackgroundColor: gradientStroke,
          pointRadius: 0,
          backgroundColor: gradientFill,
          legendColor: "#177dff",
          fill: true,
          borderWidth: 1,
          data: concluidasPorMes,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      legend: { display: false },
      tooltips: {
        bodySpacing: 4,
        mode: "nearest",
        intersect: 0,
        position: "nearest",
        xPadding: 10,
        yPadding: 10,
        caretPadding: 10,
      },
      layout: {
        padding: { left: 15, right: 15, top: 15, bottom: 15 },
      },
      scales: {
        yAxes: [{
          ticks: {
            fontColor: "rgba(0,0,0,0.5)",
            fontStyle: "500",
            beginAtZero: true,
            maxTicksLimit: 5,
            padding: 20,
          },
          gridLines: { drawTicks: false, display: false },
        }],
        xAxes: [{
          gridLines: { zeroLineColor: "transparent" },
          ticks: { padding: 20, fontColor: "rgba(0,0,0,0.5)", fontStyle: "500" },
        }],
      },
      legendCallback: function (chart) {
        var text = [];
        text.push('<ul class="' + chart.id + '-legend html-legend">');
        for (var i = 0; i < chart.data.datasets.length; i++) {
          var color = chart.data.datasets[i].backgroundColor;
          if (Array.isArray(color)) color = color[0];
          text.push(
            '<li><span style="background-color:' +
            color +
            '"></span>' +
            chart.data.datasets[i].label +
            "</li>"
          );
        }
        text.push("</ul>");
        return text.join("");
      },
    },
  });

  // Renderizar legenda
  document.getElementById("myChartLegend").innerHTML = myHtmlLegendsChart.generateLegend();

    var myLegendContainer = document.getElementById("myChartLegend");
    myLegendContainer.innerHTML = myHtmlLegendsChart.generateLegend();

    var legendItems = myLegendContainer.getElementsByTagName("li");
    for (var i = 0; i < legendItems.length; i++) {
        legendItems[i].addEventListener("click", function(event) {
        // Exemplo básico para mostrar que legenda clicada funciona
        alert("Você clicou na legenda: " + this.textContent.trim());
        });
    }
    };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      async function geocodificarLocal(local) {
        // Primeiro simplifica a local
        const localSimples = simplificarlocal(local);

      // Se estiver no fallback, retorna coordenadas fixas
      if (locaisFixos[localSimples]) {
        return locaisFixos[localSimples];
      }

      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(localSimples)}`);
        if (!response.ok) throw new Error(`HTTP error ${response.status}`);
        const data = await response.json();
        if (data.length === 0) {
          console.warn("Local não encontrada:", local);
          return null;
        }
        return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
      } catch (error) {
        console.error("Erro ao geocodificar:", local, error);
        return null;
      }
      }

      function simplificarLocal(local) {
      return local.split(' - ')[0].trim();
      }

      const locaisFixos = {
      "Museu do Oriente, Lisboa": [38.6954, -9.1870],
      "Museu da Eletricidade (MAAT), Lisboa": [38.6961, -9.2037]
      };
    
      async function adicionarPins(ocorrencias, cor, mapa) {
        for (const ocorrencia of ocorrencias) {
          const local = ocorrencia.local;
          if (!local) continue;

          const coords = await geocodificarLocal(local);
          if (coords) {
            const pin = L.circleMarker(coords, {
              radius: 8,
              color: cor,
              fillColor: cor,
              fillOpacity: 0.8
            }).addTo(mapa);
            pin.bindPopup(`<strong>${ocorrencia.titulo}</strong><br>${local}`);
          }

          await new Promise(resolve => setTimeout(resolve, 800)); // Espera 800ms entre chamadas
        }
      }

    
      document.addEventListener("DOMContentLoaded", async function () {
        const mapa = L.map("map").setView([39.5, -8], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        }).addTo(mapa);
    
        const dadosRaw = JSON.parse(localStorage.getItem("dadosOcorrencias")) || {};
        const dadosOcorrencias = Object.values(dadosRaw); // Agora é um array

        const historicoOcorrencias = JSON.parse(localStorage.getItem("historicoOcorrencias")) || [];

        const todasOcorrencias = [...dadosOcorrencias, ...historicoOcorrencias];

        for (const ocorrencia of todasOcorrencias) {
            if (!ocorrencia.local) continue;

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(ocorrencia.local)}`);
                const data = await response.json();

                if (data && data.length > 0) {
                    const { lat, lon } = data[0];

                    // Verde = ativa / Vermelho = histórico
                    const cor = dadosOcorrencias.includes(ocorrencia) ? "green" : "red";
                    const icone = L.icon({
                        iconUrl: `https://maps.google.com/mapfiles/ms/icons/${cor}-dot.png`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 32],
                        popupAnchor: [0, -32],
                    });

                    L.marker([lat, lon], { icon: icone })
                        .addTo(mapa)
                        .bindPopup(`<b>${ocorrencia.titulo}</b><br>${ocorrencia.local}`);
                } else {
                    console.warn("Local não encontrada:", ocorrencia.local);
                }
            } catch (error) {
                console.error("Erro ao geocodificar:", ocorrencia.local, error);
            }
        }
    });
    </script>
    
    <script>
      document.addEventListener('DOMContentLoaded', () => {
      const userData = JSON.parse(localStorage.getItem('googleUser'));
      if (userData) {
        const nome = userData.nome;
        const email = userData.email;
        const foto = userData.foto;
  
        if (document.getElementById('userFoto')) document.getElementById('userFoto').src = foto;
        if (document.getElementById('userFotoBig')) document.getElementById('userFotoBig').src = foto;
        if (document.getElementById('userNome')) document.getElementById('userNome').textContent = nome;
        if (document.getElementById('userNomeBig')) document.getElementById('userNomeBig').textContent = nome;
        if (document.getElementById('userEmail')) document.getElementById('userEmail').textContent = email;
      }
    });
  
    function logoutGoogle() {
      localStorage.removeItem('googleUser');
      window.location.href = 'login.html';
    }
  
    // Simulação de login Google (modo manual para teste)
    if (!localStorage.getItem("googleUser")) {
      localStorage.setItem("googleUser", JSON.stringify({
        nome: "Inês Martins",
        email: "inesn.martins14@gmail.com",
        foto: "https://i.pravatar.cc/150?img=5"
      }));
    }
    </script>
  </body>
</html>